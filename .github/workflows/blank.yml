name: CI / CD with Manual Approvals

on:
  push:
    branches:
      - master

jobs:

  # 1) Build
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build artifact
        run: |
          echo "‚ñ∂Ô∏è Building..."
          # e.g. docker build -t myapp:${{ github.run_id }} .
          # or make build

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: path/to/build

  # 2) Wait for Dev approval
  wait-dev:
    name: ‚úÖ Wait for Dev Approval
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Request Dev approval
        uses: mheap/approve-action@v1
        with:
          # Who can approve: list GitHub handles
          reviewers: |
            @your-username
          message: "Approve deployment to **dev**?"

  # 3) Deploy to Dev
  deploy-dev:
    name: üöÄ Deploy to Dev
    needs: wait-dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Deploy to Dev
        run: |
          echo "‚ñ∂Ô∏è Deploying to dev..."
          # e.g. kubectl apply -f k8s/dev/
          # or ./deploy.sh dev

  # 4) Wait for Prod approval
  wait-prod:
    name: ‚úÖ Wait for Prod Approval
    needs: deploy-dev
    runs-on: ubuntu-latest

    steps:
      - name: Request Prod approval
        uses: mheap/approve-action@v1
        with:
          reviewers: |
            @your-username
          message: "Approve deployment to **prod**?"

  # 5) Deploy to Prod
  deploy-prod:
    name: üöÄ Deploy to Prod
    needs: wait-prod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Deploy to Prod
        run: |
          echo "‚ñ∂Ô∏è Deploying to prod..."
          # e.g. kubectl apply -f k8s/prod/
          # or ./deploy.sh prod
