name: CI / CD with Single Approval for Dev & Prod

on:
  push:
    branches:
      - main

jobs:
  # 1) Build
  build:
    name: üõ† Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build artifact
        run: |
          echo "üî® Building..."
          # e.g. docker build -t myapp:${{ github.run_id }} .
          # or make build

      - name: Upload artifact
        uses: actions/upload-artifact@v4     # ‚Üê bumped from v3, v4 is current
        with:
          name: build-output
          path: path/to/build

  # 2) Single manual approval for both environments
  approval:
    name: ‚úÖ Await Dev & Prod Approval
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Request Approval
        uses: mheap/approve-action@v1
        with:
          reviewers: |
            @your-username       # who can approve
          message: |
            Please approve deployment to both **dev** and **prod**.

  # 3) Deploy to Dev (runs only after approval)
  deploy-dev:
    name: üöÄ Deploy to Dev
    needs: approval
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v3  # latest download action
        with:
          name: build-output

      - name: Deploy to Dev
        run: |
          echo "‚ñ∂Ô∏è Deploying to dev..."
          # e.g. kubectl apply -f k8s/dev/
          # or ./deploy.sh dev

  # 4) Deploy to Prod (runs only after approval)
  deploy-prod:
    name: üöÄ Deploy to Prod
    needs: approval
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Deploy to Prod
        run: |
          echo "‚ñ∂Ô∏è Deploying to prod..."
          # e.g. kubectl apply -f k8s/prod/
          # or ./deploy.sh prod
