# .github/workflows/ci-cd.yml
name: CI / CD with Parallel Dev & Prod Approvals

on:
  push:
    branches:
      - master

permissions:
  contents: read       # for checkout & download
  issues: write        # to create and close approval issues
  actions: write       # for the approval action itself

jobs:
  build:
    name: üõ† Build & Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build artifact
        run: |
          echo "üî® Building..."
          # your real build commands here, e.g.:
          # docker build -t myapp:${{ github.run_id }} .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4    # v4 replaces deprecated v3
        with:
          name: build-output
          path: path/to/build

  wait-dev:
    name: ‚úÖ Await Dev Approval
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Request Dev approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: alice,bob              # ‚Üê replace with real GitHub usernames
          issue-title: "Approve ‚ñ∂Ô∏è Dev Deployment"
          minimum-approvals: 1
          fail-on-denial: true

  wait-prod:
    name: ‚úÖ Await Prod Approval
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Request Prod approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: carol,dave            # ‚Üê replace with real GitHub usernames
          issue-title: "Approve üöÄ Prod Deployment"
          minimum-approvals: 1
          fail-on-denial: true

  deploy-dev:
    name: üöÄ Deploy to Dev
    needs: wait-dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Deploy to Dev
        run: |
          echo "‚ñ∂Ô∏è Deploying to dev..."
          # your deploy commands here, e.g.:
          # kubectl apply -f k8s/dev/

  deploy-prod:
    name: üöÄ Deploy to Prod
    needs: wait-prod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Deploy to Prod
        run: |
          echo "‚ñ∂Ô∏è Deploying to prod..."
          # your deploy commands here, e.g.:
          # kubectl apply -f k8s/prod/
