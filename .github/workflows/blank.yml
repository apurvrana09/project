name: CI / CD with Parallel Dev & Prod Approvals

on:
  push:
    branches:
      - master

permissions:
  contents: read       # for checkout/download
  issues: write        # for creating the approval issue
  actions: write       # for the approval action

jobs:
  # 1) Build
  build:
    name: üõ† Build & Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build artifact
        run: |
          echo "üî® Building..."
          # e.g. docker build -t myapp:${{ github.run_id }} .
          # or make build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4   # upgraded from v3
        with:
          name: build-output
          path: path/to/build

  # 2a) Wait for Dev approval
  wait-dev:
    name: ‚úÖ Await Dev Approval
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Request Dev approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: your-dev-approver1,your-dev-approver2
          issue-title: "Approve ‚ñ∂Ô∏è Dev Deployment"
          approve-comment: "approved"
          deny-comment: "denied"

  # 2b) Wait for Prod approval
  wait-prod:
    name: ‚úÖ Await Prod Approval
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Request Prod approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: your-prod-approver1,your-prod-approver2
          issue-title: "Approve üöÄ Prod Deployment"
          approve-comment: "approved"
          deny-comment: "denied"

  # 3a) Deploy to Dev
  deploy-dev:
    name: üöÄ Deploy to Dev
    needs: wait-dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Deploy to Dev
        run: |
          echo "‚ñ∂Ô∏è Deploying to dev..."
          # e.g. kubectl apply -f k8s/dev/
          # or ./deploy.sh dev

  # 3b) Deploy to Prod
  deploy-prod:
    name: üöÄ Deploy to Prod
    needs: wait-prod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Deploy to Prod
        run: |
          echo "‚ñ∂Ô∏è Deploying to prod..."
          # e.g. kubectl apply -f k8s/prod/
          # or ./deploy.sh prod
